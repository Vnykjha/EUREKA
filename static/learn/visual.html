<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EUREKA ‚Äî Visual Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg: #03050f;
            --surface: rgba(255, 255, 255, .05);
            --surface2: rgba(255, 255, 255, .08);
            --border: rgba(255, 255, 255, .1);
            --text: #e8f0ff;
            --text2: #7888aa;
            --ac: #4f8ef7;
            --ac2: #7eb3ff;
            --green: #34d399;
            --red: #f87171;
            --yellow: #fbbf24;
            --r: 16px;
        }

        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* BG */
        .bg-glow {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-glow span {
            position: absolute;
            border-radius: 50%;
            filter: blur(140px);
            opacity: .15;
        }

        .bg-glow .g1 {
            width: 600px;
            height: 600px;
            background: #1a3a8f;
            top: -100px;
            left: -100px;
        }

        .bg-glow .g2 {
            width: 500px;
            height: 500px;
            background: #0d2a6e;
            bottom: -50px;
            right: -50px;
        }

        /* HEADER */
        header {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 28px;
            background: rgba(3, 5, 15, .85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 1.1rem;
            font-weight: 900;
            background: linear-gradient(90deg, #4f8ef7, #7eb3ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .badge {
            padding: 3px 10px;
            background: rgba(79, 142, 247, .12);
            border: 1px solid rgba(79, 142, 247, .3);
            border-radius: 20px;
            font-size: .7rem;
            font-weight: 700;
            color: var(--ac2);
        }

        header .spacer {
            flex: 1;
        }

        .btn-icon {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text2);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: .75rem;
            cursor: pointer;
            font-family: inherit;
            transition: all .2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-icon:hover {
            border-color: var(--ac);
            color: var(--ac);
        }

        /* ORB AREA */
        .orb-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 48px 20px 24px;
            position: relative;
            z-index: 1;
        }

        .orb-outer {
            position: relative;
            width: 160px;
            height: 160px;
            cursor: pointer;
        }

        .orb {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: radial-gradient(circle at 40% 35%, rgba(100, 160, 255, .5), rgba(59, 100, 246, .15) 55%, transparent 80%);
            border: 2px solid rgba(79, 142, 247, .4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            transition: all .35s;
            box-shadow: 0 0 50px rgba(79, 142, 247, .2), inset 0 0 40px rgba(79, 142, 247, .05);
        }

        .orb:hover {
            box-shadow: 0 0 80px rgba(79, 142, 247, .4);
        }

        .orb.listening {
            animation: pulse-orb 1.4s ease-in-out infinite;
            border-color: var(--ac);
            box-shadow: 0 0 70px rgba(79, 142, 247, .5);
        }

        .orb.speaking {
            animation: speak-orb .7s ease-in-out infinite;
            border-color: var(--green);
            box-shadow: 0 0 70px rgba(52, 211, 153, .5);
        }

        .orb.processing {
            animation: spin-orb 1.5s linear infinite;
            border-color: var(--yellow);
            box-shadow: 0 0 60px rgba(251, 191, 36, .4);
        }

        @keyframes pulse-orb {

            0%,
            100% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.08)
            }
        }

        @keyframes speak-orb {

            0%,
            100% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.05)
            }
        }

        @keyframes spin-orb {
            from {
                transform: rotate(0deg)
            }

            to {
                transform: rotate(360deg)
            }
        }

        .ripple {
            position: absolute;
            inset: -14px;
            border-radius: 50%;
            border: 2px solid rgba(79, 142, 247, .25);
            animation: ripple-out 2.2s linear infinite;
            pointer-events: none;
        }

        .ripple2 {
            position: absolute;
            inset: -28px;
            border-radius: 50%;
            border: 1px solid rgba(79, 142, 247, .12);
            animation: ripple-out 2.2s linear infinite .7s;
            pointer-events: none;
        }

        @keyframes ripple-out {
            0% {
                transform: scale(1);
                opacity: .6
            }

            100% {
                transform: scale(1.25);
                opacity: 0
            }
        }

        /* WAVEFORM */
        .waveform {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 36px;
            margin-top: 20px;
        }

        .wave-bar {
            width: 4px;
            border-radius: 2px;
            background: var(--ac);
            opacity: .3;
            transition: height .1s, opacity .1s;
        }

        .waveform.active .wave-bar {
            opacity: .9;
        }

        /* STATUS */
        .status-area {
            text-align: center;
            margin-top: 16px;
        }

        .status-pill {
            display: inline-block;
            padding: 6px 18px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: .8rem;
            font-weight: 600;
            color: var(--text2);
            transition: all .3s;
        }

        .status-pill.listen {
            border-color: rgba(79, 142, 247, .4);
            color: var(--ac2);
            background: rgba(79, 142, 247, .08);
        }

        .status-pill.speak {
            border-color: rgba(52, 211, 153, .4);
            color: var(--green);
            background: rgba(52, 211, 153, .08);
        }

        .status-pill.proc {
            border-color: rgba(251, 191, 36, .4);
            color: var(--yellow);
            background: rgba(251, 191, 36, .08);
        }

        .transcript-box {
            margin-top: 10px;
            font-size: .88rem;
            color: var(--ac);
            min-height: 22px;
            text-align: center;
            padding: 0 24px;
            font-style: italic;
        }

        /* GUIDE PANEL */
        .guide-toggle {
            display: flex;
            justify-content: center;
            padding: 0 20px 16px;
            position: relative;
            z-index: 1;
        }

        .guide-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text2);
            border-radius: 10px;
            padding: 8px 20px;
            font-size: .8rem;
            cursor: pointer;
            font-family: inherit;
            transition: all .2s;
        }

        .guide-btn:hover {
            border-color: var(--ac);
            color: var(--ac);
        }

        .guide-panel {
            max-width: 700px;
            margin: 0 auto 24px;
            padding: 0 20px;
            position: relative;
            z-index: 1;
            display: none;
        }

        .guide-panel.open {
            display: block;
        }

        .guide-inner {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 24px;
        }

        .guide-title {
            font-size: .7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .8px;
            color: var(--text2);
            margin-bottom: 16px;
        }

        .guide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }

        .cmd-card {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 14px;
        }

        .cmd-phrase {
            font-weight: 700;
            color: var(--ac2);
            font-size: .82rem;
            margin-bottom: 3px;
        }

        .cmd-desc {
            color: var(--text2);
            font-size: .73rem;
            line-height: 1.5;
        }

        .guide-section-title {
            font-size: .65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .6px;
            color: var(--text2);
            margin: 16px 0 8px;
            opacity: .6;
        }

        .tip-box {
            background: rgba(79, 142, 247, .07);
            border: 1px solid rgba(79, 142, 247, .2);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: .8rem;
            color: var(--ac2);
            margin-top: 12px;
            line-height: 1.7;
        }

        /* JOURNEY BAR */
        .journey {
            max-width: 700px;
            margin: 0 auto 20px;
            padding: 0 20px;
            position: relative;
            z-index: 1;
            display: none;
        }

        .journey.on {
            display: block;
        }

        .journey-bar {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .j-step {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .j-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .65rem;
            font-weight: 700;
            color: var(--text2);
            background: var(--bg);
            transition: all .3s;
        }

        .j-dot.done {
            border-color: var(--green);
            color: var(--green);
            background: rgba(52, 211, 153, .1);
        }

        .j-dot.active {
            border-color: var(--ac);
            color: var(--ac);
            background: rgba(79, 142, 247, .12);
            box-shadow: 0 0 12px rgba(79, 142, 247, .3);
        }

        .j-label {
            font-size: .62rem;
            color: var(--text2);
            margin-top: 4px;
            text-align: center;
        }

        .j-line {
            flex: 1;
            height: 2px;
            background: var(--border);
            margin: 0 4px;
            margin-bottom: 16px;
            transition: background .3s;
        }

        .j-line.done {
            background: var(--green);
        }

        /* CONTENT AREA */
        .content-wrap {
            max-width: 720px;
            margin: 0 auto;
            padding: 0 20px 100px;
            position: relative;
            z-index: 1;
        }

        .content-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            display: none;
            animation: fadeUp .4s ease;
        }

        .content-card.on {
            display: block;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(16px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .chapter-label {
            font-size: .7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .6px;
            color: var(--text2);
            margin-bottom: 12px;
        }

        #content-text {
            font-size: 1.15rem;
            line-height: 2;
            color: var(--text);
        }

        /* READING PROGRESS */
        .read-progress {
            margin-top: 20px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }

        .read-progress.on {
            display: block;
        }

        .read-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--ac), var(--green));
            width: 0%;
            transition: width .4s;
            border-radius: 2px;
        }

        /* QUIZ */
        .quiz-wrap {
            max-width: 720px;
            margin: 0 auto;
            padding: 0 20px 100px;
            position: relative;
            z-index: 1;
            display: none;
        }

        .quiz-wrap.on {
            display: block;
            animation: fadeUp .4s ease;
        }

        .vq-card {
            background: rgba(79, 142, 247, .06);
            border: 1px solid rgba(79, 142, 247, .2);
            border-radius: 18px;
            padding: 28px;
            margin-bottom: 14px;
        }

        .vq-label {
            font-size: .65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .6px;
            color: var(--ac);
            margin-bottom: 10px;
        }

        .vq-q {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 18px;
            line-height: 1.6;
        }

        .vq-opts {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .vq-opt {
            padding: 13px 18px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 11px;
            font-size: .95rem;
            cursor: default;
            transition: all .25s;
        }

        .vq-opt.correct {
            border-color: var(--green);
            color: var(--green);
            background: rgba(52, 211, 153, .07);
        }

        .vq-opt.wrong {
            border-color: var(--red);
            color: var(--red);
            background: rgba(248, 113, 113, .07);
        }

        .vq-score {
            text-align: center;
            font-size: 2rem;
            font-weight: 900;
            padding: 28px;
            display: none;
        }

        /* FLASHCARD */
        .fc-wrap {
            max-width: 560px;
            margin: 0 auto;
            padding: 0 20px 100px;
            position: relative;
            z-index: 1;
            display: none;
        }

        .fc-wrap.on {
            display: block;
            animation: fadeUp .4s ease;
        }

        .fc-card {
            background: var(--surface);
            border: 1px solid rgba(79, 142, 247, .3);
            border-radius: 20px;
            padding: 36px 32px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .fc-counter {
            font-size: .7rem;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .fc-q {
            font-size: 1.2rem;
            font-weight: 700;
            line-height: 1.6;
        }

        .fc-a {
            font-size: 1rem;
            color: var(--green);
            margin-top: 14px;
            line-height: 1.5;
        }

        .fc-hint {
            font-size: .75rem;
            color: var(--text2);
            margin-top: 20px;
        }

        /* ERROR TOAST */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(248, 113, 113, .15);
            border: 1px solid rgba(248, 113, 113, .4);
            color: var(--red);
            border-radius: 12px;
            padding: 12px 24px;
            font-size: .85rem;
            font-weight: 600;
            z-index: 999;
            display: none;
        }

        .toast.on {
            display: block;
            animation: fadeUp .3s ease;
        }
    </style>
</head>

<body>
    <div class="bg-glow"><span class="g1"></span><span class="g2"></span></div>

    <header>
        <div class="logo">‚ö° EUREKA</div>
        <div class="badge">üëÅÔ∏è Visual Mode</div>
        <span class="spacer"></span>
        <a class="btn-icon" href="/student">‚Üê Home</a>
    </header>

    <!-- ORB -->
    <div class="orb-section">
        <div class="orb-outer" id="orbOuter" onclick="toggleListen()">
            <div class="ripple"></div>
            <div class="ripple2"></div>
            <div class="orb" id="orb">üéôÔ∏è</div>
        </div>
        <div class="waveform" id="waveform">
            <div class="wave-bar" style="height:8px"></div>
            <div class="wave-bar" style="height:18px"></div>
            <div class="wave-bar" style="height:28px"></div>
            <div class="wave-bar" style="height:14px"></div>
            <div class="wave-bar" style="height:24px"></div>
            <div class="wave-bar" style="height:10px"></div>
            <div class="wave-bar" style="height:30px"></div>
            <div class="wave-bar" style="height:16px"></div>
            <div class="wave-bar" style="height:22px"></div>
            <div class="wave-bar" style="height:8px"></div>
        </div>
        <div class="status-area">
            <div class="status-pill" id="statusPill">Initialising‚Ä¶</div>
            <div class="transcript-box" id="transcript"></div>
        </div>
    </div>

    <!-- GUIDE -->
    <div class="guide-toggle">
        <button class="guide-btn" onclick="toggleGuide()" id="guideBtn">üìñ Show Voice Command Guide</button>
    </div>
    <div class="guide-panel" id="guidePanel">
        <div class="guide-inner">
            <div class="guide-title">üó£Ô∏è Voice Command Reference</div>
            <div class="guide-section-title">Navigation</div>
            <div class="guide-grid">
                <div class="cmd-card">
                    <div class="cmd-phrase">"Grade [6‚Äì12]"</div>
                    <div class="cmd-desc">Select your grade level</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"Subject [name]"</div>
                    <div class="cmd-desc">Choose a subject</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"Chapter [topic]"</div>
                    <div class="cmd-desc">Load content on a topic</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"Home"</div>
                    <div class="cmd-desc">Go back to the home screen</div>
                </div>
            </div>
            <div class="guide-section-title">Reading Controls</div>
            <div class="guide-grid">
                <div class="cmd-card">
                    <div class="cmd-phrase">"Read"</div>
                    <div class="cmd-desc">Read the chapter aloud from the start</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"More" / "Continue"</div>
                    <div class="cmd-desc">Read the next portion of text</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"Repeat"</div>
                    <div class="cmd-desc">Re-read the last spoken section</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"Stop" / "Pause"</div>
                    <div class="cmd-desc">Stop the current speech</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"Slower"</div>
                    <div class="cmd-desc">Decrease speech speed</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"Faster"</div>
                    <div class="cmd-desc">Increase speech speed</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"Summarise"</div>
                    <div class="cmd-desc">Hear a short summary</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"New chapter"</div>
                    <div class="cmd-desc">Load a different chapter</div>
                </div>
            </div>
            <div class="guide-section-title">Activities</div>
            <div class="guide-grid">
                <div class="cmd-card">
                    <div class="cmd-phrase">"Quiz"</div>
                    <div class="cmd-desc">Start a voice quiz</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"Flashcards"</div>
                    <div class="cmd-desc">Start voice flashcards</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"Next" / "Previous"</div>
                    <div class="cmd-desc">Navigate flashcards</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"A / B / C / D"</div>
                    <div class="cmd-desc">Answer a quiz question</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"Score"</div>
                    <div class="cmd-desc">Hear your current quiz score</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"Exit" / "Quit"</div>
                    <div class="cmd-desc">Leave quiz or flashcard mode</div>
                </div>
            </div>
            <div class="guide-section-title">General</div>
            <div class="guide-grid">
                <div class="cmd-card">
                    <div class="cmd-phrase">"Help"</div>
                    <div class="cmd-desc">Hear available commands</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"What grade"</div>
                    <div class="cmd-desc">Confirm current grade</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"What subject"</div>
                    <div class="cmd-desc">Confirm current subject</div>
                </div>
                <div class="cmd-card">
                    <div class="cmd-phrase">"What chapter"</div>
                    <div class="cmd-desc">Hear the current chapter name</div>
                </div>
            </div>
            <div class="tip-box">
                üí° <strong>Tips:</strong> Speak clearly and wait for the orb to pulse blue before giving a command.
                The mic pauses while EUREKA is speaking ‚Äî it will automatically re-open when done.
                If recognition stops, click the orb to restart it.
            </div>
        </div>
    </div>

    <!-- JOURNEY BAR -->
    <div class="journey" id="journey">
        <div class="journey-bar">
            <div class="j-step">
                <div class="j-dot active" id="jGrade">G</div>
                <div class="j-label">Grade</div>
            </div>
            <div class="j-line" id="jLine1"></div>
            <div class="j-step">
                <div class="j-dot" id="jSubject">S</div>
                <div class="j-label">Subject</div>
            </div>
            <div class="j-line" id="jLine2"></div>
            <div class="j-step">
                <div class="j-dot" id="jChapter">Ch</div>
                <div class="j-label">Chapter</div>
            </div>
            <div class="j-line" id="jLine3"></div>
            <div class="j-step">
                <div class="j-dot" id="jContent">‚ñ∂</div>
                <div class="j-label">Content</div>
            </div>
        </div>
    </div>

    <!-- CONTENT -->
    <div class="content-wrap">
        <div class="content-card" id="contentCard">
            <div class="chapter-label" id="chapterLabel"></div>
            <div id="content-text"></div>
            <div class="read-progress" id="readProgress">
                <div class="read-bar" id="readBar"></div>
            </div>
        </div>
    </div>

    <!-- QUIZ -->
    <div class="quiz-wrap" id="quizWrap">
        <div id="vq-questions"></div>
        <div class="vq-score" id="vq-score"></div>
    </div>

    <!-- FLASHCARD -->
    <div class="fc-wrap" id="fcWrap">
        <div class="fc-card">
            <div class="fc-counter" id="fcCounter"></div>
            <div class="fc-q" id="fcQ"></div>
            <div class="fc-a" id="fcA"></div>
            <div class="fc-hint" id="fcHint"></div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <script>
        if (!localStorage.getItem('eureka_token')) window.location.href = '/login';
        const user = localStorage.getItem('eureka_user') || 'Student';

        /* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
        let recognition = null;
        let listening = false;
        let isSpeaking = false;
        let state = 'grade';
        let currentGrade = null, currentSubject = null, currentChapter = null;
        let rawContent = '', lastSpokenChunk = '', speechRate = 0.9;
        let readOffset = 0, chunkSize = 800;
        let quizData = [], currentQIdx = 0, correctCount = 0;
        let fcData = [], fcIdx = 0;
        const synth = window.speechSynthesis;

        const SUBJECTS = {
            6: ['Mathematics', 'Science', 'Social Science', 'English', 'Hindi'],
            7: ['Mathematics', 'Science', 'Social Science', 'English', 'Hindi'],
            8: ['Mathematics', 'Science', 'Social Science', 'English', 'Hindi'],
            9: ['Mathematics', 'Science', 'Social Science', 'English', 'Hindi', 'Computer Science'],
            10: ['Mathematics', 'Science', 'Social Science', 'English', 'Hindi', 'Computer Science'],
            11: ['Mathematics', 'Physics', 'Chemistry', 'Biology', 'Computer Science', 'English'],
            12: ['Mathematics', 'Physics', 'Chemistry', 'Biology', 'Computer Science', 'English']
        };

        /* ‚îÄ‚îÄ SPEECH SYNTHESIS ‚îÄ‚îÄ */
        function speak(text, onDone) {
            synth.cancel();
            stopRecognition();
            isSpeaking = true;
            setOrbMode('speaking');
            setStatus('Speaking‚Ä¶', 'speak');
            const u = new SpeechSynthesisUtterance(text);
            u.rate = speechRate; u.pitch = 1.05; u.lang = 'en-IN';
            u.onend = u.onerror = () => {
                isSpeaking = false;
                lastSpokenChunk = text;
                setOrbMode('listening');
                setStatus('Listening‚Ä¶', 'listen');
                setTimeout(() => { if (listening) startRecognition(); }, 400);
                if (onDone) onDone();
            };
            synth.speak(u);
        }

        /* ‚îÄ‚îÄ RECOGNITION ‚îÄ‚îÄ */
        function startRecognition() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                showToast('Browser does not support voice. Please use Chrome.');
                return;
            }
            if (recognition) { try { recognition.stop(); } catch (e) { } }
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 3;

            recognition.onresult = (e) => {
                let interim = '', final = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    if (e.results[i].isFinal) final += e.results[i][0].transcript;
                    else interim += e.results[i][0].transcript;
                }
                if (interim) setTranscript(interim);
                if (final) {
                    setTranscript(final);
                    handleCommand(final.toLowerCase().trim());
                }
            };
            recognition.onerror = (e) => {
                if (e.error === 'no-speech' || e.error === 'aborted') {
                    if (listening && !isSpeaking) setTimeout(startRecognition, 600);
                } else {
                    showToast('Mic error: ' + e.error + '. Click orb to retry.');
                }
            };
            recognition.onend = () => {
                if (listening && !isSpeaking) setTimeout(startRecognition, 600);
            };
            try { recognition.start(); } catch (e) { }
        }

        function stopRecognition() {
            if (recognition) { try { recognition.abort(); } catch (e) { } recognition = null; }
        }

        function toggleListen() {
            if (!listening) {
                listening = true;
                setOrbMode('listening');
                startRecognition();
            } else {
                listening = false;
                stopRecognition();
                synth.cancel();
                setOrbMode('idle');
                setStatus('Microphone off. Click orb to resume.', '');
            }
        }

        /* ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ */
        function setOrbMode(mode) {
            const orb = document.getElementById('orb');
            const wv = document.getElementById('waveform');
            orb.className = 'orb';
            wv.className = 'waveform';
            if (mode === 'listening') { orb.classList.add('listening'); wv.classList.add('active'); orb.textContent = 'üéôÔ∏è'; }
            else if (mode === 'speaking') { orb.classList.add('speaking'); orb.textContent = 'üîä'; wv.classList.add('active'); }
            else if (mode === 'processing') { orb.classList.add('processing'); orb.textContent = '‚öôÔ∏è'; }
            else { orb.textContent = 'üéôÔ∏è'; }
        }
        function setStatus(t, cls) {
            const p = document.getElementById('statusPill');
            p.textContent = t; p.className = 'status-pill' + (cls ? ' ' + cls : '');
        }
        function setTranscript(t) { document.getElementById('transcript').textContent = '"' + t + '"'; }
        function showToast(msg, dur = 4000) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('on');
            setTimeout(() => t.classList.remove('on'), dur);
        }
        function toggleGuide() {
            const p = document.getElementById('guidePanel');
            const b = document.getElementById('guideBtn');
            p.classList.toggle('open');
            b.textContent = p.classList.contains('open') ? '‚úï Hide Command Guide' : 'üìñ Show Voice Command Guide';
        }

        /* ‚îÄ‚îÄ JOURNEY BAR ‚îÄ‚îÄ */
        function updateJourney() {
            document.getElementById('journey').classList.add('on');
            const steps = ['jGrade', 'jSubject', 'jChapter', 'jContent'];
            const lines = ['jLine1', 'jLine2', 'jLine3'];
            const doneMap = { grade: 0, subject: 1, chapter: 2, content: 3, quiz: 3, flashcard: 3 };
            const doneUpTo = doneMap[state] ?? 0;
            steps.forEach((id, i) => {
                const el = document.getElementById(id);
                el.className = 'j-dot' + (i < doneUpTo ? ' done' : i === doneUpTo ? ' active' : '');
            });
            lines.forEach((id, i) => {
                document.getElementById(id).className = 'j-line' + (i < doneUpTo ? ' done' : '');
            });
        }

        /* ‚îÄ‚îÄ MAIN COMMAND HANDLER ‚îÄ‚îÄ */
        function handleCommand(cmd) {
            if (isSpeaking && !['stop', 'pause', 'quiet'].some(w => cmd.includes(w))) return;

            // Global
            if (cmd.includes('home') || cmd.includes('go back')) { window.location.href = '/student'; return; }
            if (cmd.includes('stop') || cmd.includes('pause') || cmd.includes('quiet')) {
                synth.cancel(); isSpeaking = false; setOrbMode('listening');
                setStatus('Listening‚Ä¶', 'listen'); startRecognition(); return;
            }
            if (cmd.includes('help')) { speakHelp(); return; }
            if (cmd.includes('what grade')) { if (currentGrade) speak(`You are on grade ${currentGrade}.`); return; }
            if (cmd.includes('what subject')) { if (currentSubject) speak(`Your subject is ${currentSubject}.`); return; }
            if (cmd.includes('what chapter')) { if (currentChapter) speak(`Your chapter is ${currentChapter}.`); return; }
            if (cmd.includes('slower')) { speechRate = Math.max(0.5, speechRate - 0.1); speak(`Speech rate decreased to ${Math.round(speechRate * 10) / 10}.`); return; }
            if (cmd.includes('faster')) { speechRate = Math.min(1.6, speechRate + 0.1); speak(`Speech rate increased to ${Math.round(speechRate * 10) / 10}.`); return; }

            // Quiz mode
            if (state === 'quiz') { handleQuizAnswer(cmd); return; }

            // Flashcard mode
            if (state === 'flashcard') {
                if (cmd.includes('next') || cmd.includes('flip') || cmd.includes('forward')) { fcNav(1); return; }
                if (cmd.includes('previous') || cmd.includes('back') || cmd.includes('last')) { fcNav(-1); return; }
                if (cmd.includes('quit') || cmd.includes('exit') || cmd.includes('done')) {
                    state = 'content'; document.getElementById('fcWrap').classList.remove('on');
                    speak('Flashcards closed. Say Read, Quiz, or Flashcards.'); return;
                }
                return;
            }

            // Grade selection
            if (state === 'grade') {
                const m = cmd.match(/\b(6|7|8|9|10|11|12)\b/);
                if (m) {
                    currentGrade = parseInt(m[0]);
                    state = 'subject'; updateJourney();
                    speak(`Grade ${currentGrade} selected. Available subjects: ${SUBJECTS[currentGrade].join(', ')}. Which subject?`);
                } else { speak(`Please say a grade between 6 and 12.`); }
                return;
            }

            // Subject selection
            if (state === 'subject') {
                const subs = SUBJECTS[currentGrade] || [];
                const found = subs.find(s => cmd.includes(s.toLowerCase()));
                if (found) {
                    currentSubject = found; state = 'chapter'; updateJourney();
                    speak(`${found} selected. Now say a chapter or topic name. For example: Photosynthesis, or Fractions.`);
                } else { speak(`I didn't catch that. Try saying one of: ${subs.join(', ')}.`); }
                return;
            }

            // Chapter / content commands when content is loaded
            if (rawContent) {
                if (cmd.includes('new chapter') || cmd.includes('change chapter')) {
                    state = 'chapter'; updateJourney();
                    speak('Sure! What topic or chapter would you like to load?'); return;
                }
                if (cmd.includes('quiz') && !cmd.includes('score')) { startVoiceQuiz(); return; }
                if (cmd.includes('flashcard')) { startVoiceFlashcards(); return; }
                if (cmd.includes('read') && !cmd.includes('more')) {
                    readOffset = 0; speakChunk(); return;
                }
                if (cmd.includes('more') || cmd.includes('continue')) { speakChunk(); return; }
                if (cmd.includes('repeat')) { speak(lastSpokenChunk); return; }
                if (cmd.includes('summarise') || cmd.includes('summarize') || cmd.includes('summary')) {
                    speak(rawContent.substring(0, 400) + '‚Ä¶'); return;
                }
                if (cmd.includes('score') && state === 'content') {
                    speak(`You have scored ${correctCount} out of ${quizData.length} so far.`); return;
                }
            }

            // Chapter loading state
            if (state === 'chapter') {
                const stripped = cmd.replace(/\b(chapter|about|on|the|my|load|open|please)\b/gi, '').trim();
                if (stripped.length > 2) { loadChapter(stripped); return; }
                speak(`Please say a topic name. For example: Cell Division, or Algebra.`);
                return;
            }

            if (rawContent) {
                speak('I did not catch that. Say Help for available commands.');
            }
        }

        /* ‚îÄ‚îÄ READING ‚îÄ‚îÄ */
        function speakChunk() {
            if (!rawContent) return;
            const chunk = rawContent.substring(readOffset, readOffset + chunkSize);
            if (!chunk) { speak('That is the end of the chapter. Say Read to start again, Quiz to test yourself, or Flashcards.'); readOffset = 0; return; }
            readOffset += chunkSize;
            const pct = Math.min(100, Math.round(readOffset / rawContent.length * 100));
            document.getElementById('readBar').style.width = pct + '%';
            speak(chunk);
        }

        /* ‚îÄ‚îÄ HELP ‚îÄ‚îÄ */
        function speakHelp() {
            const helpText = rawContent
                ? 'Available commands: Read to hear the chapter. More to continue. Repeat to re-hear. Summarise for a summary. Slower or Faster to adjust speed. New chapter to change topic. Quiz to test yourself. Flashcards to review. Stop to pause. Home to go back.'
                : `Available commands: Say Grade followed by a number 6 to 12. Then say your Subject. Then say a Chapter or topic name.`;
            speak(helpText);
        }

        /* ‚îÄ‚îÄ LOAD CHAPTER ‚îÄ‚îÄ */
        async function loadChapter(hint) {
            setOrbMode('processing');
            setStatus('Loading chapter‚Ä¶', 'proc');
            speak(`Loading chapter on ${hint}. Please wait.`);
            try {
                const r = await fetch('/adapt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: `Explain the topic "${hint}" from ${currentSubject} Grade ${currentGrade} in clear paragraphs. Use simple language ideal for a student. Avoid bullet points.`,
                        disability_profile: 'visual_impairment',
                        grade: currentGrade, subject: currentSubject, chapter: hint
                    })
                });
                const d = await r.json();
                rawContent = d.simplified || d.tts_script || d.visual_description || d.response || '';
                if (!rawContent) throw new Error('Empty response');
                currentChapter = hint;
                readOffset = 0;
                document.getElementById('chapterLabel').textContent = `Grade ${currentGrade}  ¬∑  ${currentSubject}  ¬∑  ${hint}`;
                document.getElementById('content-text').textContent = rawContent;
                document.getElementById('contentCard').classList.add('on');
                document.getElementById('readProgress').classList.add('on');
                state = 'content'; updateJourney();
                speak(`Chapter loaded: ${hint}. ${rawContent.substring(0, 500)}‚Ä¶ Say Read to hear the full chapter, Quiz to test yourself, or Flashcards to review key ideas.`);
            } catch (e) {
                showToast('Could not load chapter. Try a different topic.');
                state = 'chapter';
                speak('Sorry, I could not load that chapter. Please try another topic.');
            }
        }

        /* ‚îÄ‚îÄ QUIZ ‚îÄ‚îÄ */
        async function startVoiceQuiz() {
            speak('Starting quiz. Generating questions‚Ä¶');
            setOrbMode('processing'); setStatus('Generating quiz‚Ä¶', 'proc');
            try {
                const r = await fetch('/quiz/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: rawContent.substring(0, 2500), chapter: currentChapter, subject: currentSubject, grade: currentGrade })
                });
                const data = await r.json();
                quizData = data.questions || [];
                if (!quizData.length) { speak('Could not generate quiz. Please try again.'); return; }
                currentQIdx = 0; correctCount = 0;
                document.getElementById('fcWrap').classList.remove('on');
                document.getElementById('quizWrap').classList.add('on');
                document.getElementById('vq-score').style.display = 'none';
                renderQuizUI();
                state = 'quiz'; updateJourney();
                const q = quizData[0];
                speak(`Quiz ready. Question 1 of ${quizData.length}. ${q.question}. Options: ${q.options.map((o, i) => String.fromCharCode(65 + i) + ': ' + o).join('. ')}. Say the letter.`);
            } catch (e) { speak('Could not generate quiz. ' + e.message); }
        }

        function renderQuizUI() {
            document.getElementById('vq-questions').innerHTML = quizData.map((q, i) => `
        <div class="vq-card">
          <div class="vq-label">Question ${i + 1} of ${quizData.length}</div>
          <div class="vq-q">${q.question}</div>
          <div class="vq-opts">
            ${q.options.map((o, oi) => `<div class="vq-opt" id="opt-${i}-${oi}">${String.fromCharCode(65 + oi)}. ${o}</div>`).join('')}
          </div>
        </div>`).join('');
        }

        function handleQuizAnswer(cmd) {
            const q = quizData[currentQIdx];
            let sel = -1;
            const lm = cmd.match(/\b[abcd]\b/i);
            if (lm) sel = lm[0].toUpperCase().charCodeAt(0) - 65;
            if (sel === -1) { const nm = cmd.match(/\b[1-4]\b/); if (nm) sel = +nm[0] - 1; }
            if (sel === -1) {
                for (let i = 0; i < q.options.length; i++) {
                    if (cmd.includes(q.options[i].toLowerCase().split(' ')[0])) { sel = i; break; }
                }
            }
            if (cmd.includes('score')) { speak(`Your score so far: ${correctCount} correct.`); return; }
            if (cmd.includes('repeat') || cmd.includes('again')) {
                speak(`Question ${currentQIdx + 1}: ${q.question}. Options: ${q.options.map((o, i) => String.fromCharCode(65 + i) + ': ' + o).join('. ')}`); return;
            }
            if (sel >= 0 && sel < q.options.length) {
                const isCorrect = q.options[sel] === q.answer;
                if (isCorrect) correctCount++;
                const card = document.querySelectorAll('.vq-card')[currentQIdx];
                card.querySelectorAll('.vq-opt').forEach((el, i) => { if (i === sel) el.classList.add(isCorrect ? 'correct' : 'wrong'); });
                speak(isCorrect
                    ? `Correct! ${String.fromCharCode(65 + sel)}: ${q.options[sel]}.`
                    : `Incorrect. The correct answer was ${String.fromCharCode(65 + q.options.indexOf(q.answer))}: ${q.answer}.`,
                    () => {
                        if (currentQIdx < quizData.length - 1) {
                            currentQIdx++;
                            const nq = quizData[currentQIdx];
                            setTimeout(() => speak(`Question ${currentQIdx + 1} of ${quizData.length}: ${nq.question}. Options: ${nq.options.map((o, i) => String.fromCharCode(65 + i) + ': ' + o).join('. ')}.`), 300);
                        } else { showQuizScore(); }
                    }
                );
            } else {
                speak(`I didn't catch that. Say the letter A, B, C, or D.`);
            }
        }

        function showQuizScore() {
            const el = document.getElementById('vq-score');
            el.style.display = 'block';
            el.innerHTML = `üèÜ ${correctCount} / ${quizData.length}`;
            state = 'content'; updateJourney();
            speak(`Quiz complete! You scored ${correctCount} out of ${quizData.length}. Well done! Say Quiz to retry, Flashcards to review, or Read to hear the chapter again.`);
            fetch('/quiz/submit', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student: user, grade: currentGrade, subject: currentSubject, chapter: currentChapter, score: correctCount, total: quizData.length })
            }).catch(() => { });
        }

        /* ‚îÄ‚îÄ FLASHCARDS ‚îÄ‚îÄ */
        async function startVoiceFlashcards() {
            speak('Loading flashcards‚Ä¶');
            try {
                const r = await fetch('/flashcard/generate', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: rawContent.substring(0, 2500), chapter: currentChapter, subject: currentSubject, grade: currentGrade })
                });
                const data = await r.json();
                fcData = data.flashcards || [];
                if (!fcData.length) { speak('Could not generate flashcards. Try again.'); return; }
                fcIdx = 0;
                document.getElementById('quizWrap').classList.remove('on');
                document.getElementById('fcWrap').classList.add('on');
                state = 'flashcard'; updateJourney();
                renderFC();
                speak(`${fcData.length} flashcards ready. Card 1 of ${fcData.length}. ${fcData[0].question}. The answer is: ${fcData[0].answer}. Say Next, Previous, or Quit.`);
            } catch (e) { speak('Could not load flashcards. ' + e.message); }
        }

        function fcNav(dir) {
            fcIdx = (fcIdx + dir + fcData.length) % fcData.length;
            renderFC();
            const fc = fcData[fcIdx];
            speak(`Card ${fcIdx + 1} of ${fcData.length}. ${fc.question}. The answer is: ${fc.answer}.`);
        }

        function renderFC() {
            const fc = fcData[fcIdx];
            document.getElementById('fcCounter').textContent = `Card ${fcIdx + 1} of ${fcData.length}`;
            document.getElementById('fcQ').textContent = fc.question;
            document.getElementById('fcA').textContent = '‚Üí ' + fc.answer;
            document.getElementById('fcHint').textContent = 'Say "Next" for next card ¬∑ "Previous" for last card ¬∑ "Quit" to exit';
        }

        /* ‚îÄ‚îÄ WAVEFORM ANIMATION ‚îÄ‚îÄ */
        function animateWave() {
            const bars = document.querySelectorAll('.wave-bar');
            bars.forEach(b => {
                const h = listening ? (8 + Math.random() * 26) : (4 + Math.random() * 8);
                b.style.height = h + 'px';
            });
            requestAnimationFrame(animateWave);
        }

        /* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
        window.addEventListener('load', () => {
            listening = true;
            setOrbMode('listening');
            setStatus('Listening‚Ä¶', 'listen');
            updateJourney();
            startRecognition();
            animateWave();
            setTimeout(() => {
                speak(`Hello ${user}! I am EUREKA, your voice learning assistant. Let's begin. Please tell me your grade ‚Äî say any number from 6 to 12.`);
            }, 600);
        });

        window.addEventListener('beforeunload', () => {
            if (recognition) try { recognition.stop(); } catch (e) { }
            synth.cancel();
        });
    </script>
</body>

</html>