<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EUREKA ‚Äî Voice Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg: #050510;
            --sur: rgba(255, 255, 255, .05);
            --br: rgba(255, 255, 255, .1);
            --tx: #f0f0f0;
            --mu: #888;
            --pr: #6c63ff;
            --sc: #00d4ff;
            --ac: #ff6b9d;
            --ok: #00e676;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--tx);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            width: 100%;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--br);
            background: rgba(10, 10, 30, .9);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 900;
            background: linear-gradient(90deg, var(--pr), var(--sc));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .badge {
            padding: 5px 14px;
            border-radius: 30px;
            background: rgba(108, 99, 255, .2);
            border: 1px solid var(--pr);
            font-size: .78rem;
            font-weight: 700;
            color: var(--pr);
        }

        .back {
            color: var(--mu);
            text-decoration: none;
            font-size: .85rem;
            border: 1px solid var(--br);
            padding: 7px 14px;
            border-radius: 8px;
        }

        main {
            width: 100%;
            max-width: 820px;
            padding: 32px 20px 100px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Orb */
        .orb-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
            padding: 10px 0;
        }

        .orb {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(108, 99, 255, .25) 0%, rgba(108, 99, 255, .04) 70%);
            border: 3px solid var(--pr);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.4rem;
            box-shadow: 0 0 32px rgba(108, 99, 255, .25);
            transition: all .3s;
        }

        .orb.listening {
            border-color: var(--ac);
            background: radial-gradient(circle, rgba(255, 107, 157, .28) 0%, rgba(255, 107, 157, .04) 70%);
            box-shadow: 0 0 55px rgba(255, 107, 157, .55);
            animation: pulse 1.1s ease-in-out infinite;
        }

        .orb.speaking {
            border-color: var(--ok);
            background: radial-gradient(circle, rgba(0, 230, 118, .18) 0%, rgba(0, 230, 118, .03) 70%);
            box-shadow: 0 0 55px rgba(0, 230, 118, .4);
        }

        .orb.muted {
            border-color: var(--mu);
            opacity: .45;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.07)
            }
        }

        .orb-status {
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: .3px;
            color: var(--mu);
            text-align: center;
        }

        .orb-status.listening {
            color: var(--ac);
        }

        .orb-status.speaking {
            color: var(--ok);
        }

        .speed-badge {
            font-size: .78rem;
            color: var(--sc);
            background: rgba(0, 212, 255, .1);
            border: 1px solid rgba(0, 212, 255, .2);
            padding: 3px 12px;
            border-radius: 20px;
        }

        /* Transcript */
        .heard {
            background: var(--sur);
            border: 1px solid var(--br);
            border-radius: 14px;
            padding: 14px 20px;
            font-size: 1rem;
            min-height: 48px;
            color: var(--tx);
        }

        .heard em {
            color: var(--mu);
            font-style: italic;
        }

        /* Breadcrumb */
        .crumb {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
            font-size: .82rem;
            color: var(--mu);
        }

        .crumb strong {
            color: var(--sc);
        }

        /* Options */
        .opts {
            background: var(--sur);
            border: 1px solid var(--br);
            border-radius: 16px;
            padding: 18px 22px;
        }

        .opts h3 {
            font-size: .75rem;
            text-transform: uppercase;
            letter-spacing: .5px;
            color: var(--sc);
            margin-bottom: 12px;
        }

        .opt-list {
            display: flex;
            flex-direction: column;
            gap: 7px;
        }

        .opt {
            display: flex;
            gap: 14px;
            align-items: center;
            padding: 11px 14px;
            border-radius: 9px;
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--br);
            font-size: .95rem;
            transition: all .2s;
        }

        .opt.hi {
            border-color: var(--sc);
            background: rgba(0, 212, 255, .1);
        }

        .opt-n {
            font-size: .78rem;
            font-weight: 900;
            color: var(--pr);
            min-width: 22px;
        }

        /* Content */
        .content {
            background: var(--sur);
            border: 1px solid var(--br);
            border-radius: 18px;
            padding: 24px;
            display: none;
        }

        .content.on {
            display: block;
        }

        .content h3 {
            font-size: .75rem;
            text-transform: uppercase;
            letter-spacing: .5px;
            color: var(--sc);
            margin-bottom: 14px;
        }

        .ct {
            font-size: 1rem;
            line-height: 1.85;
        }

        .ct strong {
            color: var(--sc);
        }

        .ct ul,
        .ct ol {
            padding-left: 1.3em;
        }

        /* Spinner */
        .spin-wrap {
            display: flex;
            gap: 10px;
            align-items: center;
            color: var(--mu);
        }

        .spin {
            width: 20px;
            height: 20px;
            border: 3px solid var(--br);
            border-top-color: var(--pr);
            border-radius: 50%;
            animation: spin .7s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        /* Commands */
        .cmds {
            background: rgba(108, 99, 255, .05);
            border: 1px solid rgba(108, 99, 255, .2);
            border-radius: 16px;
            padding: 18px 22px;
        }

        .cmds h3 {
            font-size: .75rem;
            text-transform: uppercase;
            letter-spacing: .5px;
            color: var(--pr);
            margin-bottom: 12px;
        }

        .cmd-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
            gap: 8px;
        }

        .chip {
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--br);
            border-radius: 7px;
            padding: 7px 11px;
            font-size: .8rem;
        }

        .chip code {
            color: var(--sc);
            font-weight: 700;
        }

        .chip span {
            color: var(--mu);
            display: block;
            font-size: .7rem;
            margin-top: 2px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--pr);
            color: #fff;
            padding: 10px 22px;
            border-radius: 30px;
            font-weight: 700;
            font-size: .85rem;
            opacity: 0;
            transition: all .35s;
            pointer-events: none;
            z-index: 999;
        }

        .toast.on {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>

<body>

    <header>
        <div class="logo">‚ö° EUREKA</div>
        <div class="badge">üëÅÔ∏è Voice Mode</div>
        <a class="back" href="/ui">‚Üê Visual UI</a>
    </header>

    <main>
        <div class="orb-wrap">
            <div class="orb" id="orb">üéôÔ∏è</div>
            <div class="orb-status" id="orbStatus">Initialising‚Ä¶</div>
            <div class="speed-badge" id="speedBadge">Speed: 1.4√ó</div>
        </div>

        <div class="heard" id="heard"><em>Waiting for voice‚Ä¶</em></div>

        <div class="crumb" id="crumb"><span>Home</span></div>

        <div class="opts" id="optsPanel">
            <h3 id="optsTitle">Choose a Grade</h3>
            <div class="opt-list" id="optList"></div>
        </div>

        <div class="content" id="contentPanel">
            <h3>üìñ <span id="cpTitle"></span></h3>
            <div class="ct" id="ct"></div>
        </div>

        <div class="cmds">
            <h3>üé§ Voice Commands ‚Äî always listening, no button needed</h3>
            <div class="cmd-grid">
                <div class="chip"><code>"grade 8"</code><span>Select grade</span></div>
                <div class="chip"><code>"open science"</code><span>Select subject</span></div>
                <div class="chip"><code>"select 3"</code><span>Pick option by number</span></div>
                <div class="chip"><code>"3"</code><span>Shortcut: say just the number</span></div>
                <div class="chip"><code>"read"</code><span>Fetch &amp; read chapter</span></div>
                <div class="chip"><code>"stop"</code><span>Stop speaking</span></div>
                <div class="chip"><code>"faster"</code><span>Increase speech speed</span></div>
                <div class="chip"><code>"slower"</code><span>Decrease speech speed</span></div>
                <div class="chip"><code>"normal speed"</code><span>Reset to 1.0√ó</span></div>
                <div class="chip"><code>"repeat"</code><span>Repeat last speech</span></div>
                <div class="chip"><code>"back"</code><span>Go back</span></div>
                <div class="chip"><code>"home"</code><span>Start over</span></div>
                <div class="chip"><code>"sleep"</code><span>Pause mic</span></div>
                <div class="chip"><code>"wake up"</code><span>Resume mic</span></div>
                <div class="chip"><code>"help"</code><span>List commands</span></div>
                <div class="chip"><code>"profile adhd"</code><span>Set learning profile</span></div>
            </div>
        </div>
    </main>

    <div class="toast" id="toast"></div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let grade = null, subject = null, chapter = null;
        let profile = 'visual_impairment';
        let screen = 'home';      // home | grades | subjects | content
        let opts = [];
        let lastText = '';
        let speechRate = 1.4;
        let recognition = null;
        let micOn = false;
        let muted = false;
        let speaking = false;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CURRICULUM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const SUBJECTS = {};
        for (let g = 6; g <= 10; g++) SUBJECTS[g] = ['Mathematics', 'Science', 'Social Science', 'English', 'Hindi'];
        SUBJECTS[11] = SUBJECTS[12] = ['Physics', 'Chemistry', 'Biology', 'Mathematics', 'English'];

        const CHAPTERS = {
            'Mathematics': ['Real Numbers', 'Polynomials', 'Pair of Linear Equations', 'Quadratic Equations', 'Arithmetic Progressions', 'Triangles', 'Coordinate Geometry', 'Introduction to Trigonometry', 'Circles', 'Areas Related to Circles', 'Surface Areas and Volumes', 'Statistics', 'Probability'],
            'Science': ['Chemical Reactions and Equations', 'Acids, Bases and Salts', 'Metals and Non-metals', 'Carbon and its Compounds', 'Life Processes', 'Control and Coordination', 'How do Organisms Reproduce', 'Heredity', 'Light Reflection and Refraction', 'Human Eye and Colourful World', 'Electricity', 'Magnetic Effects of Electric Current', 'Our Environment'],
            'Social Science': ['The Rise of Nationalism in Europe', 'Nationalism in India', 'The Making of a Global World', 'The Age of Industrialisation', 'Print Culture and the Modern World', 'Resources and Development', 'Forest and Wildlife Resources', 'Water Resources', 'Agriculture', 'Minerals and Energy Resources', 'Manufacturing Industries', 'Power Sharing', 'Federalism', 'Democracy and Diversity', 'Gender Religion and Caste', 'Political Parties', 'Outcomes of Democracy', 'Development', 'Sectors of the Indian Economy', 'Money and Credit', 'Globalisation and the Indian Economy', 'Consumer Rights', 'Nazism and the Rise of Hitler'],
            'English': ['A Letter to God', 'Nelson Mandela Long Walk to Freedom', 'Two Stories about Flying', 'From the Diary of Anne Frank', 'Glimpses of India', 'Mijbil the Otter', 'Madam Rides the Bus', 'The Sermon at Benares', 'The Proposal'],
            'Hindi': ['Surdas', 'Tulsidas', 'Dev', 'Jaishankar Prasad', 'Suryakant Tripathi Nirala', 'Nagarjun', 'Girijakumar Mathur', 'Rituraj'],
            'Physics': ['Electric Charges and Fields', 'Electrostatic Potential and Capacitance', 'Current Electricity', 'Moving Charges and Magnetism', 'Magnetism and Matter', 'Electromagnetic Induction', 'Alternating Current', 'Electromagnetic Waves', 'Ray Optics', 'Wave Optics', 'Dual Nature of Radiation and Matter', 'Atoms', 'Nuclei', 'Semiconductor Electronics'],
            'Chemistry': ['The Solid State', 'Solutions', 'Electrochemistry', 'Chemical Kinetics', 'Surface Chemistry', 'General Principles of Extraction', 'The p-Block Elements', 'The d and f Block Elements', 'Coordination Compounds', 'Haloalkanes and Haloarenes', 'Alcohols Phenols and Ethers', 'Aldehydes Ketones and Carboxylic Acids', 'Amines', 'Biomolecules'],
            'Biology': ['Reproduction in Organisms', 'Sexual Reproduction in Flowering Plants', 'Human Reproduction', 'Reproductive Health', 'Principles of Inheritance and Variation', 'Molecular Basis of Inheritance', 'Evolution', 'Human Health and Disease', 'Strategies for Enhancement in Food Production', 'Microbes in Human Welfare', 'Biotechnology Principles and Processes', 'Biotechnology and its Applications', 'Organisms and Populations', 'Ecosystem', 'Biodiversity and Conservation', 'Environmental Issues'],
        };

        const W2N = { one: 1, two: 2, three: 3, four: 4, five: 5, six: 6, seven: 7, eight: 8, nine: 9, ten: 10, eleven: 11, twelve: 12, thirteen: 13, fourteen: 14, fifteen: 15, sixteen: 16, seventeen: 17, eighteen: 18, nineteen: 19, twenty: 20, twenty_one: 21, twenty_two: 22, twenty_three: 23 };
        function norm(s) { return s.replace(/\b(twenty[- ]?(one|two|three))\b/gi, m => m.replace(/\s|-/, '_')).replace(/\b(one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen|twenty|twenty_one|twenty_two|twenty_three)\b/gi, m => W2N[m.toLowerCase().replace(/ /, '_')] || m); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function say(text, cb) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.rate = speechRate;
            u.lang = 'en-IN';
            lastText = text;
            speaking = true;
            micPause();
            setOrb('speaking');
            u.onend = u.onerror = () => { speaking = false; micResume(); if (cb) cb(); };
            window.speechSynthesis.speak(u);
        }
        function stopSay() { window.speechSynthesis.cancel(); speaking = false; setOrb('listening'); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MIC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function setOrb(state) {
            const orb = document.getElementById('orb');
            const st = document.getElementById('orbStatus');
            orb.className = 'orb ' + state;
            const lbl = { idle: 'üéôÔ∏è Always listening', listening: 'üëÇ Listening‚Ä¶', speaking: 'üîä Speaking‚Ä¶', muted: 'üîá Muted ‚Äî say "wake up"' };
            st.textContent = lbl[state] || '';
            st.className = 'orb-status ' + state;
        }

        function micPause() { if (recognition && micOn) { try { recognition.stop(); } catch (e) { } } }
        function micResume() { if (!muted && recognition) setTimeout(() => { try { recognition.start(); } catch (e) { } }, 150); }

        function initMic() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) { say('Voice recognition not supported. Please use Chrome.'); return; }

            recognition = new SR();
            recognition.lang = 'en-IN';
            recognition.continuous = true;      // ‚Üê stays open permanently
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => { micOn = true; setOrb('listening'); };

            recognition.onresult = (e) => {
                const res = e.results[e.results.length - 1];
                if (!res.isFinal) return;
                const raw = res[0].transcript.trim().toLowerCase();
                document.getElementById('heard').textContent = 'üé§ ' + raw;
                handleCmd(norm(raw));
            };

            recognition.onerror = (ev) => {
                micOn = false;
                if (ev.error === 'no-speech' || ev.error === 'aborted') return; // silent restart
                toast('Mic: ' + ev.error);
            };

            recognition.onend = () => {
                micOn = false;
                if (!muted && !speaking) {
                    setTimeout(() => { try { recognition.start(); } catch (e) { } }, 200);
                } else if (!speaking) {
                    setOrb(muted ? 'muted' : 'idle');
                }
            };

            try { recognition.start(); } catch (e) { }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMMANDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function handleCmd(cmd) {
            // ‚îÄ‚îÄ Sleep / Wake ‚îÄ‚îÄ
            if (/\b(sleep|stop listening|mute)\b/.test(cmd)) { muted = true; micPause(); setOrb('muted'); return; }
            if (/\b(wake up|start listening|unmute)\b/.test(cmd)) { muted = false; micResume(); say('Listening.'); return; }

            // ‚îÄ‚îÄ Stop speaking ‚îÄ‚îÄ
            if (/\b(stop|quiet|silence|cancel)\b/.test(cmd) && !cmd.includes('stop listening')) { stopSay(); return; }

            // ‚îÄ‚îÄ Speed ‚îÄ‚îÄ
            if (/faster/.test(cmd)) { speechRate = Math.min(2.5, +(speechRate + 0.2).toFixed(1)); say('Speed ' + speechRate); updateSpeedBadge(); return; }
            if (/slower/.test(cmd)) { speechRate = Math.max(0.5, +(speechRate - 0.2).toFixed(1)); say('Speed ' + speechRate); updateSpeedBadge(); return; }
            if (/normal speed|reset speed/.test(cmd)) { speechRate = 1.0; say('Normal speed.'); updateSpeedBadge(); return; }

            // ‚îÄ‚îÄ Repeat ‚îÄ‚îÄ
            if (/\b(repeat|again|say again)\b/.test(cmd)) { say(lastText); return; }

            // ‚îÄ‚îÄ Help ‚îÄ‚îÄ
            if (/\bhelp\b/.test(cmd)) { say('Say grade followed by a number. Say open followed by subject or chapter name. Say select followed by a number. Say read to hear content. Say faster or slower to change speed. Say stop to stop me. Say back or home to navigate.'); return; }

            // ‚îÄ‚îÄ Profile ‚îÄ‚îÄ
            const pMap = { adhd: 'adhd', dyslexia: 'dyslexia', visual: 'visual_impairment', hearing: 'hearing_impairment', cognitive: 'cognitive', general: '' };
            for (const [k, v] of Object.entries(pMap)) {
                if (cmd.includes('profile ' + k) || cmd.includes('set ' + k)) { profile = v; say('Profile set to ' + k); return; }
            }

            // ‚îÄ‚îÄ Home ‚îÄ‚îÄ
            if (/\b(home|start over|restart)\b/.test(cmd)) { goHome(); return; }

            // ‚îÄ‚îÄ Back ‚îÄ‚îÄ
            if (/\b(back|go back|previous)\b/.test(cmd)) { goBack(); return; }

            // ‚îÄ‚îÄ Grade ‚Äî BEFORE any digit matching ‚îÄ‚îÄ
            const gm = cmd.match(/\bgrade\s*(\d+)\b/);
            if (gm) { selectGrade(+gm[1]); return; }

            // ‚îÄ‚îÄ Read ‚îÄ‚îÄ
            if (/\b(read|learn|explain|teach|start)\b/.test(cmd)) {
                if (chapter) { fetchAndRead(); return; }
                say('Please select a chapter first.'); return;
            }

            // ‚îÄ‚îÄ Open named target ‚îÄ‚îÄ
            if (/^(open|go to)\s/.test(cmd)) { matchName(cmd.replace(/^(open|go to)\s+/, '')); return; }

            // ‚îÄ‚îÄ Select N (explicit keyword) ‚îÄ‚îÄ
            const selm = cmd.match(/\b(?:select|option|pick|choose|number|item)\s+(\d+)\b/);
            if (selm) { selectOpt(+selm[1] - 1); return; }

            // ‚îÄ‚îÄ Bare number only ‚îÄ‚îÄ
            const bare = cmd.match(/^(\d+)$/);
            if (bare) { selectOpt(+bare[1] - 1); return; }

            // ‚îÄ‚îÄ Fallback: try name match ‚îÄ‚îÄ
            matchName(cmd);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function goHome() {
            screen = 'home'; grade = null; subject = null; chapter = null;
            document.getElementById('contentPanel').classList.remove('on');
            setBread(['Home']);
            opts = Array.from({ length: 7 }, (_, i) => 'Grade ' + (i + 6));
            renderOpts(opts, 'Choose your Grade');
        }

        function selectGrade(g) {
            if (!SUBJECTS[g]) { say('Grade ' + g + ' not available. Grades 6 to 12.'); return; }
            grade = g; screen = 'grades';
            opts = SUBJECTS[g];
            setBread(['Home', 'Grade ' + g]);
            renderOpts(opts, 'Grade ' + g + ' ‚Äî Choose Subject');
        }

        function selectSubject(subj) {
            const key = Object.keys(CHAPTERS).find(k => k.toLowerCase() === subj.toLowerCase()) || subj;
            subject = key; screen = 'subjects';
            opts = CHAPTERS[key] || [];
            setBread(['Home', 'Grade ' + grade, key]);
            renderOpts(opts, key + ' ‚Äî Choose Chapter');
        }

        function selectChapter(chap) {
            chapter = chap; screen = 'chapters';
            setBread(['Home', 'Grade ' + grade, subject, chap]);
            document.getElementById('contentPanel').classList.add('on');
            document.getElementById('cpTitle').textContent = chap;
            document.getElementById('ct').innerHTML = '';
        }

        function goBack() {
            if (screen === 'chapters' || screen === 'content') { chapter = null; selectSubject(subject); }
            else if (screen === 'subjects') { selectGrade(grade); }
            else if (screen === 'grades') { goHome(); }
        }

        function selectOpt(idx) {
            if (idx < 0 || idx >= opts.length) { say('Option ' + (idx + 1) + ' not available. ' + opts.length + ' options. Say a number between 1 and ' + opts.length + '.'); return; }
            hiOpt(idx);
            if (screen === 'home') { selectGrade(+(opts[idx].replace('Grade ', ''))); }
            else if (screen === 'grades') { selectSubject(opts[idx]); }
            else if (screen === 'subjects') { selectChapter(opts[idx]); }
        }

        function matchName(name) {
            const idx = opts.findIndex(o => o.toLowerCase().includes(name) || name.includes(o.toLowerCase()));
            if (idx !== -1) { selectOpt(idx); return; }
            say('Not found: ' + name + '. Say help for commands.');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FETCH + READ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function fetchAndRead() {
            if (!grade || !subject || !chapter) { say('Please pick a grade, subject, and chapter first.'); return; }
            document.getElementById('ct').innerHTML = '<div class="spin-wrap"><div class="spin"></div> Generating‚Ä¶</div>';
            document.getElementById('contentPanel').classList.add('on');
            say('Generating content for ' + chapter + '. Please wait.');
            try {
                const r = await fetch('/adapt', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
                        query: 'Explain the chapter "' + chapter + '" from ' + subject + ' Grade ' + grade + ' NCERT.',
                        disability_profile: profile || 'visual_impairment',
                        grade, subject, chapter
                    })
                });
                const d = await r.json();
                if (!r.ok) throw new Error(d.detail || 'API error');
                const txt = d.visual_description || d.tts_script || d.simplified || '';
                document.getElementById('ct').innerHTML = marked.parse(txt);
                screen = 'content';
                const plain = txt.replace(/\*\*/g, '').replace(/\*/g, '').replace(/#+\s/g, '').replace(/\n/g, ' ');
                say(plain);
            } catch (e) {
                document.getElementById('ct').innerHTML = '<p style="color:#ff6b9d">Error: ' + e.message + '</p>';
                say('Error: ' + e.message);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UI HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderOpts(list, title) {
            document.getElementById('optsTitle').textContent = title;
            document.getElementById('optList').innerHTML = list.map((item, i) =>
                `<div class="opt" id="opt${i}" onclick="selectOpt(${i})"><span class="opt-n">${i + 1}</span><span>${item}</span></div>`
            ).join('');
        }
        function hiOpt(idx) { document.querySelectorAll('.opt').forEach((e, i) => e.classList.toggle('hi', i === idx)); }
        function setBread(parts) {
            document.getElementById('crumb').innerHTML = parts.map((p, i) => i === 0 ? `<span>${p}</span>` : `<span style="color:var(--br)">‚Ä∫</span><strong>${p}</strong>`).join('');
        }
        function updateSpeedBadge() { document.getElementById('speedBadge').textContent = 'Speed: ' + speechRate + '√ó'; }
        function toast(msg) {
            const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('on');
            setTimeout(() => t.classList.remove('on'), 3500);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOOT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.addEventListener('load', () => {
            initMic();
            // Slight delay so mic can initialise before first TTS
            setTimeout(goHome, 600);
        });
    </script>
</body>

</html>